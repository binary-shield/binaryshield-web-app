name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  notify-start:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Extract commit info
        id: commit-info
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1 | sed 's/"/\\"/g')
          AUTHOR="${{ github.event.head_commit.author.name || github.actor }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          PROJECT_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          
      - name: Notify Discord - CI Started
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"[${{ steps.commit-info.outputs.project_name }}] üöÄ CI Started\", \"color\": 16776960, \"fields\": [{\"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true}, {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true}, {\"name\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"inline\": false}, {\"name\": \"Commit\", \"value\": \"\`${{ steps.commit-info.outputs.short_sha }}\` ${{ steps.commit-info.outputs.commit_msg }}\", \"inline\": false}, {\"name\": \"Author\", \"value\": \"${{ steps.commit-info.outputs.author }}\", \"inline\": true}, {\"name\": \"Checks\", \"value\": \"Lint, Build\", \"inline\": true}], \"footer\": {\"text\": \"Pipeline is running...\"}, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            "${{ secrets.DISCORD_WEBHOOK }}"
            
  build-and-test:
    runs-on: ubuntu-latest
    needs: [notify-start]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  notify-success:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: success()
    timeout-minutes: 3
    steps:
      - name: Extract commit info
        id: commit-info
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1 | sed 's/"/\\"/g')
          AUTHOR="${{ github.event.head_commit.author.name || github.actor }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          PROJECT_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT

      - name: Notify Discord - CI Success
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"[${{ steps.commit-info.outputs.project_name }}] ‚úÖ CI Passed\", \"color\": 5763719, \"fields\": [{\"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true}, {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true}, {\"name\": \"Commit\", \"value\": \"\`${{ steps.commit-info.outputs.short_sha }}\` ${{ steps.commit-info.outputs.commit_msg }}\", \"inline\": false}, {\"name\": \"Author\", \"value\": \"${{ steps.commit-info.outputs.author }}\", \"inline\": true}, {\"name\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"inline\": true}, {\"name\": \"Checks\", \"value\": \"‚úì Lint\\n‚úì Build\", \"inline\": false}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            "${{ secrets.DISCORD_WEBHOOK }}"

  notify-failure:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: failure()
    timeout-minutes: 3
    steps:
      - name: Extract commit info
        id: commit-info
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1 | sed 's/"/\\"/g')
          AUTHOR="${{ github.event.head_commit.author.name || github.actor }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          PROJECT_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT

      - name: Notify Discord - CI Failed
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"[${{ steps.commit-info.outputs.project_name }}] ‚ùå CI Failed\", \"color\": 15548997, \"fields\": [{\"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true}, {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true}, {\"name\": \"Commit\", \"value\": \"\`${{ steps.commit-info.outputs.short_sha }}\` ${{ steps.commit-info.outputs.commit_msg }}\", \"inline\": false}, {\"name\": \"Author\", \"value\": \"${{ steps.commit-info.outputs.author }}\", \"inline\": true}, {\"name\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"inline\": true}, {\"name\": \"Logs\", \"value\": \"[View Pipeline Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            "${{ secrets.DISCORD_WEBHOOK }}"
